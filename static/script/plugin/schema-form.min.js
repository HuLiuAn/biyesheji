/*!  2016-03-21 */
!function(a,b){"function"==typeof define&&define.amd?define(["angular","objectpath","tv4"],b):"object"==typeof exports?module.exports=b(require("angular"),require("objectpath"),require("tv4")):a.schemaForm=b(a.angular,a.objectpath,a.tv4)}(this,function(a,b,c){var d=[];try{a.module("ngSanitize"),d.push("ngSanitize")}catch(e){}try{a.module("ui.sortable"),d.push("ui.sortable")}catch(e){}try{a.module("angularSpectrumColorpicker"),d.push("angularSpectrumColorpicker")}catch(e){}var f=a.module("schemaForm",d);return a.module("schemaForm").provider("sfPath",[function(){var c=window.ObjectPath||b,d={parse:c.parse};1===a.version.major&&a.version.minor<3?d.stringify=function(a){return Array.isArray(a)?a.join("."):a.toString()}:d.stringify=c.stringify,d.normalize=function(a,b){return d.stringify(Array.isArray(a)?a:d.parse(a),b)},this.parse=d.parse,this.stringify=d.stringify,this.normalize=d.normalize,this.$get=function(){return d}}]),a.module("schemaForm").factory("sfSelect",["sfPath",function(a){var b=/^\d+$/;return function(c,d,e){d||(d=this);var f="string"==typeof c?a.parse(c):c;if("undefined"!=typeof e&&1===f.length)return d[f[0]]=e,d;"undefined"!=typeof e&&"undefined"==typeof d[f[0]]&&(d[f[0]]=f.length>2&&b.test(f[1])?[]:{});for(var g=d[f[0]],h=1;h<f.length;h++){if(""===f[h])return;if("undefined"!=typeof e){if(h===f.length-1)return g[f[h]]=e,e;var i=g[f[h]];"undefined"!=typeof i&&null!==i||(i=b.test(f[h+1])?[]:{},g[f[h]]=i),g=i}else g&&(g=g[f[h]])}return g}}]),a.module("schemaForm").provider("sfBuilder",["sfPathProvider",function(b){var c=/[A-Z]/g,d=function(a,b){return b=b||"_",a.replace(c,function(a,c){return(c?b:"")+a.toLowerCase()})},e=0,f={sfField:function(a){a.fieldFrag.firstChild.setAttribute("sf-field",e),a.lookup["f"+e]=a.form,e++},ngModel:function(a){if(a.form.key){var c=a.form.key;a.state.keyRedaction&&(c=c.slice(a.state.keyRedaction));var d;if(a.state.modelValue)d=a.state.modelValue;else{var e=b.stringify(c).replace(/"/g,"&quot;");d=a.state.modelName||"model",e&&(d+=("["!==e[0]?".":"")+e)}for(var f=a.fieldFrag.querySelectorAll("[sf-field-model]"),g=0;g<f.length;g++){var h=f[g],i=h.getAttribute("sf-field-model");if(i&&""!==i)if("replaceAll"===i)for(var j=h.attributes,k=0;k<j.length;k++)j[k].value&&-1!==j[k].value.indexOf("$$value")&&(j[k].value=j[k].value.replace(/\$\$value\$\$/g,d));else{var l=h.getAttribute(i);l&&l.indexOf("$$value$$")?h.setAttribute(i,l.replace(/\$\$value\$\$/g,d)):h.setAttribute(i,d)}else h.setAttribute("ng-model",d)}}},simpleTransclusion:function(a){var b=a.build(a.form.items,a.path+".items",a.state);a.fieldFrag.firstChild.appendChild(b)},ngModelOptions:function(a){a.form.ngModelOptions&&Object.keys(a.form.ngModelOptions).length>0&&a.fieldFrag.firstChild.setAttribute("ng-model-options",JSON.stringify(a.form.ngModelOptions))},transclusion:function(a){var b=a.fieldFrag.querySelectorAll("[sf-field-transclude]");if(b.length)for(var c=0;c<b.length;c++){var d=b[c],e=d.getAttribute("sf-field-transclude")||"items",f=a.form[e];if(f){var g=a.build(f,a.path+"."+e,a.state);d.appendChild(g)}}},condition:function(a){if(a.form.condition){var c="evalExpr("+a.path+'.condition, { model: model, "arrayIndex": $index})';if(a.form.key){var d=b.stringify(a.form.key);c="evalExpr("+a.path+'.condition,{ model: model, "arrayIndex": $index, "modelValue": model'+("["===d[0]?"":".")+d+"})"}for(var e=a.fieldFrag.children||a.fieldFrag.childNodes,f=0;f<e.length;f++){var g=e[f],h=g.getAttribute("ng-if");g.setAttribute("ng-if",h?"("+h+") || ("+c+")":c)}}},array:function(c){var d=c.fieldFrag.querySelector("[schema-form-array-items]");if(d){if(state=a.copy(c.state),state.keyRedaction=state.keyRedaction||0,state.keyRedaction+=c.form.key.length+1,c.form.schema&&c.form.schema.items&&c.form.schema.items.type&&-1===c.form.schema.items.type.indexOf("object")&&-1===c.form.schema.items.type.indexOf("array")){b.stringify(c.form.key).replace(/"/g,"&quot;")+"[$index]";state.modelValue="modelArray[$index]"}else state.modelName="item";state.arrayCompatFlag=!0;var e=c.build(c.form.items,c.path+".items",state);d.appendChild(e)}}};this.builders=f;var g=[f.sfField,f.ngModel,f.ngModelOptions,f.condition];this.stdBuilders=g,this.$get=["$templateCache","schemaFormDecorators","sfPath",function(a,b,c){var e=function(a,b){if(a.key){var d=b[c.stringify(a.key)];if(d){for(;d.firstChild;)d.removeChild(d.firstChild);return d}}},h=function(a,b,c,f,g,i,j){i=i||{},j=j||Object.create(null),g=g||"schemaForm.form";var k=document.createDocumentFragment();return a.reduce(function(a,k,l){if(!k.type)return a;var m=b[k.type]||b["default"];if(m.replace){var n;i.arrayCompatFlag=!1;var o=document.createElement("div"),p=c(k,m)||c(k,b["default"]);for(o.innerHTML=p,n=document.createDocumentFragment();o.childNodes.length>0;)n.appendChild(o.childNodes[0]);var q={fieldFrag:n,form:k,lookup:j,state:i,path:g+"["+l+"]",build:function(a,d,e){return h(a,b,c,f,d,e,j)}},r=k.builder||m.builder;"function"==typeof r?r(q):r.forEach(function(a){a(q)}),(e(k,f)||a).appendChild(n)}else{var s=document.createElement(d(b.__name,"-"));i.arrayCompatFlag?s.setAttribute("form","copyWithIndex($index)"):s.setAttribute("form",g+"["+l+"]"),(e(k,f)||a).appendChild(s)}return a},k),k};return{build:function(b,c,d,e){return h(b,c,function(b,c){return"template"===b.type?b.template:a.get(c.template)},d,void 0,void 0,e)},builder:f,stdBuilders:g,internalBuild:h}}]}]),a.module("schemaForm").provider("schemaFormDecorators",["$compileProvider","sfPathProvider",function(b,c){var d="",e={},f=function(a,b){"sfDecorator"===a&&(a=d);var c=e[a];return c[b.type]?c[b.type].template:c["default"].template},g=function(d){b.directive(d,["$parse","$compile","$http","$templateCache","$interpolate","$q","sfErrorMessage","sfPath","sfSelect",function(b,e,g,h,i,j,k,l,m){return{restrict:"AE",replace:!1,transclude:!1,scope:!0,require:"?^sfSchema",link:function(b,n,o,p){b.$on("schemaFormPropagateNgModelController",function(a,c){a.stopPropagation(),a.preventDefault(),b.ngModel=c}),b.showTitle=function(){return b.form&&b.form.notitle!==!0&&b.form.title},b.listToCheckboxValues=function(b){var c={};return a.forEach(b,function(a){c[a]=!0}),c},b.checkboxValuesToList=function(b){var c=[];return a.forEach(b,function(a,b){a&&c.push(b)}),c},b.buttonClick=function(c,d){a.isFunction(d.onClick)?d.onClick(c,d):a.isString(d.onClick)&&(p?p.evalInParentScope(d.onClick,{$event:c,form:d}):b.$eval(d.onClick,{$event:c,form:d}))},b.evalExpr=function(a,c){return p?p.evalInParentScope(a,c):b.$eval(a,c)},b.evalInScope=function(a,c){return a?b.$eval(a,c):void 0},b.interp=function(a,b){return a&&i(a)(b)},b.hasSuccess=function(){return b.ngModel?b.ngModel.$valid&&(!b.ngModel.$pristine||!b.ngModel.$isEmpty(b.ngModel.$modelValue)):!1},b.hasError=function(){return b.ngModel?b.ngModel.$invalid&&!b.ngModel.$pristine:!1},b.errorMessage=function(a){return k.interpolate(a&&a.code+""||"default",b.ngModel&&b.ngModel.$modelValue||"",b.ngModel&&b.ngModel.$viewValue||"",b.form,b.options&&b.options.validationMessage)};var q=b.$watch(o.form,function(i){if(i){i.ngModelOptions=i.ngModelOptions||{},b.form=i;var k;if("template"===i.type&&i.template)k=j.when(i.template);else{var o="template"===i.type?i.templateUrl:f(d,i);k=g.get(o,{cache:h}).then(function(a){return a.data})}k.then(function(d){if(i.key){var f=i.key?c.stringify(i.key).replace(/"/g,"&quot;"):"";d=d.replace(/\$\$value\$\$/g,"model"+("["!==f[0]?".":"")+f)}if(n.html(d),i.condition){var g='evalExpr(form.condition,{ model: model, "arrayIndex": arrayIndex})';i.key&&(g='evalExpr(form.condition,{ model: model, "arrayIndex": arrayIndex, "modelValue": model'+l.stringify(i.key)+"})"),a.forEach(n.children(),function(a){var b=a.getAttribute("ng-if");a.setAttribute("ng-if",b?"("+b+") || ("+g+")":g)})}e(n.contents())(b)}),i.key&&(b.$on("schemaForm.error."+i.key.join("."),function(a,c,d,e){d!==!0&&d!==!1||(e=d,d=void 0),b.ngModel&&c&&(b.ngModel.$setDirty?b.ngModel.$setDirty():(b.ngModel.$dirty=!0,b.ngModel.$pristine=!1),d&&(i.validationMessage||(i.validationMessage={}),i.validationMessage[c]=d),b.ngModel.$setValidity(c,e===!0),e===!0&&b.$broadcast("schemaFormValidate"))}),b.$on("$destroy",function(){if(!b.externalDestructionInProgress){var a=i.destroyStrategy||b.options&&b.options.destroyStrategy||"remove";if(i.key&&"retain"!==a){var c=b.model;if(i.key.length>1&&(c=m(i.key.slice(0,i.key.length-1),c)),void 0===c)return;var d=i.schema&&i.schema.type||"";"empty"===a&&-1!==d.indexOf("string")?c[i.key.slice(-1)]="":"empty"===a&&-1!==d.indexOf("object")?c[i.key.slice(-1)]={}:"empty"===a&&-1!==d.indexOf("array")?c[i.key.slice(-1)]=[]:"null"===a?c[i.key.slice(-1)]=null:delete c[i.key.slice(-1)]}}})),q()}})}}}])},h=function(c,d,e){e=a.isDefined(e)?e:!1,b.directive("sf"+a.uppercase(c[0])+c.substr(1),function(){return{restrict:"EAC",scope:!0,replace:!0,transclude:e,template:'<sf-decorator form="form"></sf-decorator>',link:function(b,d,e){var f={items:"c",titleMap:"c",schema:"c"},g={type:c},h=!0;a.forEach(e,function(c,d){if("$"!==d[0]&&0!==d.indexOf("ng")&&"sfField"!==d){var i=function(c){a.isDefined(c)&&c!==g[d]&&(g[d]=c,h&&g.type&&(g.key||a.isUndefined(e.key))&&(b.form=g,h=!1))};"model"===d?b.$watch(c,function(a){a&&b.model!==a&&(b.model=a)}):"c"===f[d]?b.$watchCollection(c,i):e.$observe(d,i)}})}}})};this.createDecorator=function(b,c){e[b]={__name:b},a.forEach(c,function(a,c){e[b][c]={template:a,replace:!1,builder:[]}}),e[d]||(d=b),g(b)},this.defineDecorator=function(b,c){e[b]={__name:b},a.forEach(c,function(c,d){c.builder=c.builder||[],c.replace=a.isDefined(c.replace)?c.replace:!0,e[b][d]=c}),e[d]||(d=b),g(b)},this.createDirective=h,this.createDirectives=function(b){a.forEach(b,function(a,b){h(b,a)})},this.decorator=function(a){return a=a||d,e[a]},this.addMapping=function(a,b,c,d,f){e[a]&&(e[a][b]={template:c,builder:d,replace:!!f})},this.defineAddOn=function(a,b,c,d){e[a]&&(e[a][b]={template:c,builder:d,replace:!0})},this.$get=function(){return{decorator:function(a){return e[a]||e[d]},defaultDecorator:d}},g("sfDecorator")}]),a.module("schemaForm").provider("sfErrorMessage",function(){var b={"default":"Field does not validate",0:"Invalid type, expected {{schema.type}}",1:"No enum match for: {{viewValue}}",10:'Data does not match any schemas from "anyOf"',11:'Data does not match any schemas from "oneOf"',12:'Data is valid against more than one schema from "oneOf"',13:'Data matches schema from "not"',100:"值应为其中之一： {{schema.multipleOf}}",101:"{{viewValue}} ,不得小于 {{schema.minimum}}",102:"{{viewValue}} is equal to the exclusive minimum {{schema.minimum}}",103:"{{viewValue}} ,不得大于 {{schema.maximum}}",104:"{{viewValue}} is equal to the exclusive maximum {{schema.maximum}}",105:"请输入数字",200:"String is too short ({{viewValue.length}} chars), minimum {{schema.minLength}}",201:"文本太长：({{viewValue.length}} 字符), 应小于： {{schema.maxLength}}",202:"请输入有效格式: {{schema.pattern}}",300:"Too few properties defined, minimum {{schema.minProperties}}",301:"Too many properties defined, maximum {{schema.maxProperties}}",302:"必填！",303:"Additional properties not allowed",304:"Dependency failed - key must exist",400:"太短({{value.length}}), 不得小于 {{schema.minItems}}",401:"过长({{value.length}}), 不得大于 {{schema.maxItems}}",402:"已存在相同的项",403:"Additional items not allowed",500:"请输入有效格式",501:'Keyword failed: "{{title}}"',600:"Circular $refs",1e3:"Unknown property (not in schema)"};b.number=b[105],b.required=b[302],b.min=b[101],b.max=b[103],b.maxlength=b[201],b.minlength=b[200],b.pattern=b[202],this.setDefaultMessages=function(a){b=a},this.getDefaultMessages=function(){return b},this.setDefaultMessage=function(a,c){b[a]=c},this.$get=["$interpolate",function(c){var d={};return d.defaultMessages=b,d.interpolate=function(d,e,f,g,h){h=h||{};var i=g.validationMessage||{};0===d.indexOf("tv4-")&&(d=d.substring(4));var j=i["default"]||h["default"]||"";[i,h,b].some(function(b){return a.isString(b)||a.isFunction(b)?(j=b,!0):b&&b[d]?(j=b[d],!0):void 0});var k={error:d,value:e,viewValue:f,form:g,schema:g.schema,title:g.title||g.schema&&g.schema.title};return a.isFunction(j)?j(k):c(j)(k)},d}]}),a.module("schemaForm").provider("schemaForm",["sfPathProvider",function(b){var c=function(a){if(Array.isArray(a)&&2==a.length){if("null"===a[0])return a[1];if("null"===a[1])return a[0]}return a},d=function(a){var b=[];return a.forEach(function(a){b.push({name:a,value:a})}),b},e=function(b,c){if(!a.isArray(b)){var d=[];return c?a.forEach(c,function(a,c){d.push({name:b[a],value:a})}):a.forEach(b,function(a,b){d.push({name:a,value:b})}),d}return b},f=function(b,d,e){var f=p[c(d.type)];if(f)for(var g,h=0;h<f.length;h++)if(g=f[h](b,d,e))return g.schema["x-schema-form"]&&a.isObject(g.schema["x-schema-form"])&&(g=a.extend(g,g.schema["x-schema-form"])),g},g=function(b,c,d){d=d||{};var f=d.global&&d.global.formDefaults?a.copy(d.global.formDefaults):{};return d.global&&d.global.supressPropertyTitles===!0?f.title=c.title:f.title=c.title||b,c.description&&(f.description=c.description),d.required!==!0&&c.required!==!0||(f.required=!0),c.maxLength&&(f.maxlength=c.maxLength),c.minLength&&(f.minlength=c.minLength),(c.readOnly||c.readonly)&&(f.readonly=!0),c.minimum&&(f.minimum=c.minimum+(c.exclusiveMinimum?1:0)),c.maximum&&(f.maximum=c.maximum-(c.exclusiveMaximum?1:0)),c.validationMessage&&(f.validationMessage=c.validationMessage),c.enumNames&&(f.titleMap=e(c.enumNames,c["enum"])),f.schema=c,f.ngModelOptions=f.ngModelOptions||{},f},h=function(a,d,e){if("string"===c(d.type)&&!d["enum"]){var f=g(a,d,e);return f.key=e.path,f.type="text",e.lookup[b.stringify(e.path)]=f,f}},i=function(a,d,e){if("number"===c(d.type)){var f=g(a,d,e);return f.key=e.path,f.type="number",e.lookup[b.stringify(e.path)]=f,f}},j=function(a,d,e){if("integer"===c(d.type)){var f=g(a,d,e);return f.key=e.path,f.type="number",e.lookup[b.stringify(e.path)]=f,f}},k=function(a,d,e){if("boolean"===c(d.type)){var f=g(a,d,e);return f.key=e.path,f.type="checkbox",e.lookup[b.stringify(e.path)]=f,f}},l=function(a,e,f){if("string"===c(e.type)&&e["enum"]){var h=g(a,e,f);return h.key=f.path,h.type="select",h.titleMap||(h.titleMap=d(e["enum"])),f.lookup[b.stringify(f.path)]=h,h}},m=function(a,e,f){if("array"===c(e.type)&&e.items&&e.items["enum"]){var h=g(a,e,f);return h.key=f.path,h.type="checkboxes",h.titleMap||(h.titleMap=d(e.items["enum"])),f.lookup[b.stringify(f.path)]=h,h}},n=function(d,e,h){if("object"===c(e.type)){var i=g(d,e,h);return i.type="fieldset",i.items=[],h.lookup[b.stringify(h.path)]=i,a.forEach(e.properties,function(a,c){var d=h.path.slice();if(d.push(c),h.ignore[b.stringify(d)]!==!0){var g=e.required&&-1!==e.required.indexOf(c),j=f(c,a,{path:d,required:g||!1,lookup:h.lookup,ignore:h.ignore,global:h.global});j&&i.items.push(j)}}),i}},o=function(a,d,e){if("array"===c(d.type)){var h=g(a,d,e);h.type="array",h.key=e.path,e.lookup[b.stringify(e.path)]=h;var i=d.required&&-1!==d.required.indexOf(e.path[e.path.length-1]),j=e.path.slice();return j.push(""),h.items=[f(a,d.items,{path:j,required:i||!1,lookup:e.lookup,ignore:e.ignore,global:e.global})],h}},p={string:[l,h],object:[n],number:[i],integer:[j],"boolean":[k],array:[m,o]},q=function(a){return a};this.defaults=p,this.stdFormObj=g,this.defaultFormDefinition=f,this.postProcess=function(a){q=a},this.appendRule=function(a,b){p[a]||(p[a]=[]),p[a].push(b)},this.prependRule=function(a,b){p[a]||(p[a]=[]),p[a].unshift(b)},this.createStandardForm=g,this.$get=function(){var d={};return d.merge=function(c,f,g,h,i,j){f=f||["*"],h=h||{},i=i||c.readonly||c.readOnly;var k=d.defaults(c,g,h),l=f.indexOf("*");-1!==l&&(f=f.slice(0,l).concat(k.form).concat(f.slice(l+1)));var m=k.lookup;return q(f.map(function(f){if("string"==typeof f&&(f={key:f}),f.key&&"string"==typeof f.key&&(f.key=b.parse(f.key)),f.titleMap&&(f.titleMap=e(f.titleMap)),f.itemForm){f.items=[];var k=b.stringify(f.key),l=m[k];a.forEach(l.items,function(b){var c=a.copy(f.itemForm);c.key=b.key,f.items.push(c)})}if(f.key){var n=b.stringify(f.key);if(m[n]){var o=m[n];a.forEach(o,function(a,b){void 0===f[b]&&(f[b]=o[b])})}}return i===!0&&(f.readonly=!0),f.items&&(f.items=d.merge(c,f.items,g,h,f.readonly,j)),f.tabs&&a.forEach(f.tabs,function(a){a.items=d.merge(c,a.items,g,h,f.readonly,j)}),"checkbox"===f.type&&a.isUndefined(f.schema["default"])&&(f.schema["default"]=!1),j&&"template"===f.type&&!f.template&&f.templateUrl&&j.push(f),f}))},d.defaults=function(b,d,e){var g=[],h={};if(d=d||{},e=e||{},"object"!==c(b.type))throw new Error('Not implemented. Only type "object" allowed at root level of schema.');return a.forEach(b.properties,function(a,c){if(d[c]!==!0){var i=b.required&&-1!==b.required.indexOf(c),j=f(c,a,{path:[c],lookup:h,ignore:d,required:i,global:e});j&&g.push(j)}}),{form:g,lookup:h}},d.traverseSchema=function(b,c,d,e){e=a.isDefined(e)?e:!0,d=d||[];var f=function(b,c,d){if(c(b,d),a.forEach(b.properties,function(a,b){var e=d.slice();e.push(b),f(a,c,e)}),!e&&b.items){var g=d.slice();g.push(""),f(b.items,c,g)}};f(b,c,d||[])},d.traverseForm=function(b,c){c(b),a.forEach(b.items,function(a){d.traverseForm(a,c)}),b.tabs&&a.forEach(b.tabs,function(b){a.forEach(b.items,function(a){d.traverseForm(a,c)})})},d}}]),a.module("schemaForm").factory("sfValidator",[function(){var b={};return b.validate=function(b,d){if(!b)return{valid:!0};var e=b.schema;if(!e)return{valid:!0};""===d&&(d=void 0),"number"===b.type&&null===d&&(d=void 0);var f={type:"object",properties:{}},g=b.key[b.key.length-1];f.properties[g]=e,b.required&&(f.required=[g]);var h={};return a.isDefined(d)&&(h[g]=d),c.validateResult(h,f)},b}]),a.module("schemaForm").directive("sfArray",["sfSelect","schemaForm","sfValidator","sfPath",function(b,c,d,e){var f=function(a){return function(b){b.key&&(b.key[b.key.indexOf("")]=a)}};return{restrict:"A",scope:!0,require:"?ngModel",link:function(g,h,i,j){var k={};g.validateArray=a.noop,j&&g.$emit("schemaFormPropagateNgModelController",j);var l=g.$watch(i.sfArray,function(h){if(h){var i=b(h.key,g.model),m=e.normalize(h.key);if(g.$watch("model"+("["!==m[0]?".":"")+m,function(a){i=g.modelArray=a}),a.isUndefined(i)&&(i=[],b(h.key,g.model,i)),g.modelArray=i,h.items){var n=h.items[0];h.items.length>1&&(n={type:"section",items:h.items.map(function(b){return b.ngModelOptions=h.ngModelOptions,a.isUndefined(b.readonly)&&(b.readonly=h.readonly),b})})}if(g.copyWithIndex=function(b){if(!k[b]&&n){var d=a.copy(n);d.arrayIndex=b,c.traverseForm(d,f(b)),k[b]=d}return k[b]},g.appendToArray=function(){var d=i.length,e=g.copyWithIndex(d);if(c.traverseForm(e,function(c){if(c.key){var d;a.isDefined(c["default"])&&(d=c["default"]),a.isDefined(c.schema)&&a.isDefined(c.schema["default"])&&(d=c.schema["default"]),a.isDefined(d)&&b(c.key,g.model,d)}}),d===i.length){var f,j=b("schema.items.type",h);"object"===j?f={}:"array"===j&&(f=[]),i.push(f)}return g.validateArray(),i},g.deleteFromArray=function(a){return i.splice(a,1),g.validateArray(),j&&j.$setDirty&&j.$setDirty(),i},h.titleMap||h.startEmpty===!0||0!==i.length||g.appendToArray(),h.titleMap&&h.titleMap.length>0){g.titleMapValues=[];var o=function(a){g.titleMapValues=[],a=a||[],h.titleMap.forEach(function(b){g.titleMapValues.push(-1!==a.indexOf(b.value))})};o(g.modelArray),g.$watchCollection("modelArray",o),g.$watchCollection("titleMapValues",function(a,b){if(a&&a!==b){for(var c=g.modelArray;c.length>0;)c.pop();h.titleMap.forEach(function(b,d){a[d]&&c.push(b.value)}),g.validateArray()}})}if(j){var p;g.validateArray=function(){var a=d.validate(h,g.modelArray.length>0?g.modelArray:void 0);Object.keys(j.$error).filter(function(a){return 0===a.indexOf("tv4-")}).forEach(function(a){j.$setValidity(a,!0)}),a.valid!==!1||!a.error||""!==a.error.dataPath&&a.error.dataPath!=="/"+h.key[h.key.length-1]||(j.$setViewValue(g.modelArray),p=a.error,j.$setValidity("tv4-"+a.error.code,!1))},g.$on("schemaFormValidate",g.validateArray),g.hasSuccess=function(){return g.options&&g.options.pristine&&g.options.pristine.success===!1?j.$valid&&!j.$pristine&&!j.$isEmpty(j.$modelValue):j.$valid&&(!j.$pristine||!j.$isEmpty(j.$modelValue))},g.hasError=function(){return g.options&&g.options.pristine&&g.options.pristine.errors===!1?j.$invalid&&!j.$pristine:j.$invalid},g.schemaError=function(){return p}}l()}})}}}]),a.module("schemaForm").directive("sfChanged",function(){return{require:"ngModel",restrict:"AC",scope:!1,link:function(b,c,d,e){var f=b.$eval(d.sfChanged);f&&f.onChange&&e.$viewChangeListeners.push(function(){a.isFunction(f.onChange)?f.onChange(e.$modelValue,f):b.evalExpr(f.onChange,{modelValue:e.$modelValue,form:f})})}}}),a.module("schemaForm").directive("sfField",["$parse","$compile","$http","$templateCache","$interpolate","$q","sfErrorMessage","sfPath","sfSelect",function(b,c,d,e,f,g,h,i,j){return{restrict:"AE",replace:!1,transclude:!1,scope:!0,require:"^sfSchema",link:{pre:function(a,b,c,d){a.$on("schemaFormPropagateNgModelController",function(b,c){b.stopPropagation(),b.preventDefault(),a.ngModel=c}),a.form=d.lookup["f"+c.sfField]},post:function(b,c,d,e){b.showTitle=function(){return b.form&&b.form.notitle!==!0&&b.form.title},b.listToCheckboxValues=function(b){var c={};return a.forEach(b,function(a){c[a]=!0}),c},b.checkboxValuesToList=function(b){var c=[];return a.forEach(b,function(a,b){a&&c.push(b)}),c},b.buttonClick=function(c,d){a.isFunction(d.onClick)?d.onClick(c,d):a.isString(d.onClick)&&(e?e.evalInParentScope(d.onClick,{$event:c,form:d}):b.$eval(d.onClick,{$event:c,form:d}))},b.evalExpr=function(a,c){return e?e.evalInParentScope(a,c):b.$eval(a,c)},b.evalInScope=function(a,c){return a?b.$eval(a,c):void 0},b.interp=function(a,b){return a&&f(a)(b)},b.hasSuccess=function(){return b.ngModel?b.options&&b.options.pristine&&b.options.pristine.success===!1?b.ngModel.$valid&&!b.ngModel.$pristine&&!b.ngModel.$isEmpty(b.ngModel.$modelValue):b.ngModel.$valid&&(!b.ngModel.$pristine||!b.ngModel.$isEmpty(b.ngModel.$modelValue)):!1},b.hasError=function(){return b.ngModel?b.options&&b.options.pristine&&b.options.pristine.errors===!1?b.ngModel.$invalid&&!b.ngModel.$pristine:b.ngModel.$invalid:!1},b.errorMessage=function(a){return h.interpolate(a&&a.code+""||"default",b.ngModel&&b.ngModel.$modelValue||"",b.ngModel&&b.ngModel.$viewValue||"",b.form,b.options&&b.options.validationMessage)};var g=b.form;g.key&&(b.$on("schemaForm.error."+g.key.join("."),function(a,c,d,e){d!==!0&&d!==!1||(e=d,d=void 0),b.ngModel&&c&&(b.ngModel.$setDirty?b.ngModel.$setDirty():(b.ngModel.$dirty=!0,b.ngModel.$pristine=!1),d&&(g.validationMessage||(g.validationMessage={}),g.validationMessage[c]=d),b.ngModel.$setValidity(c,e===!0),e===!0&&b.$broadcast("schemaFormValidate"))}),b.$on("$destroy",function(){if(!b.externalDestructionInProgress){var a=g.destroyStrategy||b.options&&b.options.destroyStrategy||"remove";if(g.key&&"retain"!==a){var c=b.model;if(g.key.length>1&&(c=j(g.key.slice(0,g.key.length-1),c)),void 0===c)return;var d=g.schema&&g.schema.type||"";"empty"===a&&-1!==d.indexOf("string")?c[g.key.slice(-1)]="":"empty"===a&&-1!==d.indexOf("object")?c[g.key.slice(-1)]={}:"empty"===a&&-1!==d.indexOf("array")?c[g.key.slice(-1)]=[]:"null"===a?c[g.key.slice(-1)]=null:delete c[g.key.slice(-1)]}}}))}}}}]),a.module("schemaForm").directive("sfMessage",["$injector","sfErrorMessage",function(b,c){var d=b.has("$sanitize")?b.get("$sanitize"):function(a){return a};return{scope:!1,restrict:"EA",link:function(b,e,f){var g="";f.sfMessage&&b.$watch(f.sfMessage,function(a){a&&(g=d(a),j(!!b.ngModel))});var h,i=function(a){a!==h&&(e.html(a),h=a)},j=function(d){if(d)if(b.hasError()){var e=[];a.forEach(b.ngModel&&b.ngModel.$error,function(a,b){a&&e.push(b)}),e=e.filter(function(a){return"schemaForm"!==a});var f=e[0];i(f?c.interpolate(f,b.ngModel.$modelValue,b.ngModel.$viewValue,b.form,b.options&&b.options.validationMessage):g)}else i(g);else i(g)};j();var k=b.$watch("ngModel",function(a){a&&(a.$parsers.push(function(a){return j(!0),a}),a.$formatters.push(function(a){return j(!0),a}),k())});b.$watchCollection("ngModel.$error",function(){j(!!b.ngModel)})}}}]),a.module("schemaForm").directive("sfNewArray",["sfSelect","sfPath","schemaForm",function(b,c,d){return{scope:!1,link:function(e,f,g){e.min=0,e.modelArray=e.$eval(g.sfNewArray);var h=function(){e.modelArray=e.$eval(g.sfNewArray),e.ngModel&&e.ngModel.$pristine&&e.firstDigest&&(!e.options||e.options.validateOnRender!==!0)||e.validateField&&e.validateField()},i=function(){e.form&&e.form.onChange&&(a.isFunction(e.form.onChange)?e.form.onChange(e.modelArray,e.form):e.evalExpr(e.form.onChange,{modelValue:e.modelArray,form:e.form}))},j=function(){var a=e.modelArray;if(!a){var d=c.parse(g.sfNewArray);a=[],b(d,e,a),e.modelArray=a}return a},k=e.$watch("form",function(a){if(a){if(a.titleMap||a.startEmpty===!0||e.modelArray&&0!==e.modelArray.length||e.appendToArray(),e.form&&e.form.schema&&e.form.schema.uniqueItems===!0?(e.$watch(g.sfNewArray,h,!0),e.$watch([g.sfNewArray,g.sfNewArray+".length"],i)):e.$watchGroup?e.$watchGroup([g.sfNewArray,g.sfNewArray+".length"],function(){h(),i()}):(e.$watch(g.sfNewArray,function(){h(),i()}),e.$watch(g.sfNewArray+".length",function(){h(),i()})),a.titleMap&&a.titleMap.length>0){e.titleMapValues=[];var b=function(b){e.titleMapValues=[],b=b||[],a.titleMap.forEach(function(a){e.titleMapValues.push(-1!==b.indexOf(a.value))})};b(e.modelArray),e.$watchCollection("modelArray",b),e.$watchCollection("titleMapValues",function(b,c){if(b&&b!==c){for(var d=j();d.length>0;)d.pop();a.titleMap.forEach(function(a,c){b[c]&&d.push(a.value)}),e.validateField&&e.validateField()}})}k()}});e.appendToArray=function(){var c,f=j();if(e.form&&e.form.schema&&e.form.schema.items){var g=e.form.schema.items;g.type&&-1!==g.type.indexOf("object")?(c={},e.options&&e.options.setSchemaDefaults===!1||(c=a.isDefined(g["default"])?g["default"]:c,c&&d.traverseSchema(g,function(d,e){a.isDefined(d["default"])&&b(e,c,d["default"])}))):g.type&&-1!==g.type.indexOf("array")?(c=[],e.options&&e.options.setSchemaDefaults===!1||(c=g["default"]||c)):e.options&&e.options.setSchemaDefaults===!1||(c=g["default"]||c)}return f.push(c),f},e.deleteFromArray=function(a){var b=e.modelArray;return b&&b.splice(a,1),b};var l=function(a){return function(b){b.key&&(b.key[b.key.indexOf("")]=a)}},m={};e.copyWithIndex=function(b){var c=e.form;if(!m[b]){var f=c.items[0];if(c.items.length>1&&(f={type:"section",items:c.items.map(function(b){return b.ngModelOptions=c.ngModelOptions,a.isUndefined(b.readonly)&&(b.readonly=c.readonly),b})}),f){var g=a.copy(f);g.arrayIndex=b,d.traverseForm(g,l(b)),m[b]=g}}return m[b]}}}}]),a.module("schemaForm").directive("sfSchema",["$compile","$http","$templateCache","$q","schemaForm","schemaFormDecorators","sfSelect","sfPath","sfBuilder",function(b,c,d,e,f,g,h,i,j){return{scope:{schema:"=sfSchema",initialForm:"=sfForm",model:"=sfModel",options:"=sfOptions"},controller:["$scope",function(a){this.evalInParentScope=function(b,c){return a.$parent.$eval(b,c)};var b=this;a.lookup=function(a){return a&&(b.lookup=a),b.lookup}}],replace:!1,restrict:"A",transclude:!0,require:"?form",link:function(i,k,l,m,n){i.formCtrl=m;var o={};n(i,function(a){if(a.addClass("schema-form-ignore"),k.prepend(a),k[0].querySelectorAll){var b=k[0].querySelectorAll("[ng-model]");if(b)for(var c=0;c<b.length;c++){var d=b[c].getAttribute("ng-model");o[d.substring(d.indexOf(".")+1)]=!0}}});var p,q={},r=function(a,b){var g=[],h=f.merge(a,b,o,i.options,void 0,g);g.length>0?e.all(g.map(function(a){return c.get(a.templateUrl,{cache:d}).then(function(b){a.template=b.data})})).then(function(){s(a,b,h)}):s(a,b,h)},s=function(c,d,e){p&&(i.externalDestructionInProgress=!0,p.$destroy(),i.externalDestructionInProgress=!1),p=i.$new(),p.schemaForm={form:e,schema:c},k.children(":not(.schema-form-ignore)").remove();for(var m={},n=k[0].querySelectorAll("*[sf-insert-field]"),o=0;o<n.length;o++)m[n[o].getAttribute("sf-insert-field")]=n[o];var q=g.decorator(l.sfUseDecorator),r=Object.create(null);i.lookup(r),k[0].appendChild(j.build(e,q,m,r)),p.firstDigest=!0,setTimeout(function(){p.firstDigest=!1},0),b(k.children())(p),i.options&&i.options.setSchemaDefaults===!1||f.traverseSchema(c,function(b,c){if(a.isDefined(b["default"])){var d=h(c,i.model);a.isUndefined(d)&&h(c,i.model,b["default"])}}),i.$emit("sf-render-finished",k)},t=["*"];i.$watch(function(){var a=i.schema,b=i.initialForm||t;b&&a&&a.type&&(q.form!==b||q.schema!==a)&&Object.keys(a.properties).length>0&&(q.schema=a,q.form=b,r(a,b))}),i.$on("schemaFormRedraw",function(){var a=i.schema,b=i.initialForm||["*"];a&&r(a,b)}),i.$on("$destroy",function(){i.externalDestructionInProgress=!0}),i.evalExpr=function(a,b){return i.$parent.$eval(a,b)}}}}]),a.module("schemaForm").directive("schemaValidate",["sfValidator","$parse","sfSelect",function(b,c,d){return{restrict:"A",scope:!1,priority:500,require:"ngModel",link:function(c,e,f,g){c.$emit("schemaFormPropagateNgModelController",g);var h=null,i=c.$eval(f.schemaValidate);i.copyValueTo&&g.$viewChangeListeners.push(function(){var b=i.copyValueTo;a.forEach(b,function(a){d(a,c.model,g.$modelValue)})});var j=function(a){if(!i)return a;if(c.options&&c.options.tv4Validation===!1)return a;var d=b.validate(i,a);Object.keys(g.$error).filter(function(a){return 0===a.indexOf("tv4-")}).forEach(function(a){g.$setValidity(a,!0)});{if(d.valid)return a;if(g.$setValidity("tv4-"+d.error.code,!1),h=d.error,g.$validators)return a}};"function"==typeof i.ngModel&&i.ngModel(g),["$parsers","$viewChangeListeners","$formatters"].forEach(function(a){i[a]&&g[a]&&i[a].forEach(function(b){g[a].push(b)})}),["$validators","$asyncValidators"].forEach(function(b){i[b]&&g[b]&&a.forEach(i[b],function(a,c){g[b][c]=a})}),g.$parsers.push(j),g.$validators&&(g.$validators.schemaForm=function(){return!Object.keys(g.$error).some(function(a){return"schemaForm"!==a})});var k=i.schema;c.validateField=function(){k&&-1!==k.type.indexOf("array")&&j(g.$modelValue),g.$setDirty?(g.$setDirty(),g.$setViewValue(g.$viewValue),g.$commitViewValue(),i.required&&g.$isEmpty(g.$modelValue)&&g.$setValidity("tv4-302",!1)):g.$setViewValue(g.$viewValue)},g.$formatters.push(function(a){return!g.$pristine||!c.firstDigest||c.options&&c.options.validateOnRender===!0?(j(g.$modelValue),a):a}),c.$on("schemaFormValidate",c.validateField),c.schemaError=function(){return h}}}}]),f});